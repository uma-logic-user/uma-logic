# .github/workflows/optimize_2025.yml
# UMA-Logic PRO - 2025å¹´ãƒ‡ãƒ¼ã‚¿ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼†AIå­¦ç¿’
# ã‚¹ãƒãƒ›ã‹ã‚‰ãƒœã‚¿ãƒ³ä¸€ã¤ã§å®Ÿè¡Œå¯èƒ½

name: ğŸ§ª 2025å¹´ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

on:
  workflow_dispatch:
    inputs:
      learning_rate:
        description: 'å­¦ç¿’ç‡ï¼ˆ0.01-0.5ï¼‰'
        required: false
        default: '0.1'
      iterations:
        description: 'æœ€é©åŒ–ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ•°'
        required: false
        default: '100'
      notify:
        description: 'é€šçŸ¥ã‚’é€ä¿¡ã™ã‚‹'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

env:
  TZ: Asia/Tokyo

jobs:
  simulate-2025:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      # 1. ç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: ğŸ“¥ ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: ğŸ Pythonç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ğŸ“¦ ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: ğŸ“ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
        run: |
          mkdir -p data/archive
          mkdir -p data/models

      # 2. ãƒ‡ãƒ¼ã‚¿æº–å‚™
      - name: ğŸ“‚ å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–å½¢å¼ã«æ•´ç†
        run: python scripts/archive_manager.py --archive-all || echo "Archive step skipped"

      - name: ğŸ” ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’å†æ§‹ç¯‰
        run: python scripts/archive_manager.py --rebuild-index || echo "Index rebuild skipped"

      # 3. 2025å¹´ãƒ‡ãƒ¼ã‚¿ã§AIå­¦ç¿’
      - name: ğŸ§  2025å¹´ãƒ‡ãƒ¼ã‚¿ã§AIå­¦ç¿’ã‚’å®Ÿè¡Œ
        id: optimize
        run: |
          python scripts/ensemble_agents.py --optimize --source data/archive/2025 \
            --learning-rate ${{ github.event.inputs.learning_rate }} \
            --iterations ${{ github.event.inputs.iterations }}
          
          # çµæœã‚’å–å¾—ã—ã¦ãƒ­ã‚°ã«å‡ºåŠ›
          if [ -f "data/models/weights.json" ]; then
            HIT_RATE=$(python3 -c "import json; print(json.load(open('data/models/weights.json')).get('test_metrics', {}).get('hit_rate', 0))" 2>/dev/null || echo "0")
            ROI=$(python3 -c "import json; print(json.load(open('data/models/weights.json')).get('test_metrics', {}).get('recovery_rate', 0))" 2>/dev/null || echo "0")
            echo "hit_rate=$HIT_RATE" >> $GITHUB_OUTPUT
            echo "roi=$ROI" >> $GITHUB_OUTPUT
          fi

      # 4. çµæœã‚’è‡ªå‹•ä¿å­˜ï¼ˆä¿®æ­£ç‰ˆï¼šstashã‚’ä½¿ç”¨ã—ã¦ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆå›é¿ï¼‰
      - name: ğŸ’¾ å­¦ç¿’çµæœã‚’ãƒªãƒã‚¸ãƒˆãƒªã«è‡ªå‹•ä¿å­˜
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "UMA-Logic Bot"
          
          # å¤‰æ›´ã‚’ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°
          git add data/models/weights.json data/archive/ || true
          
          # å¤‰æ›´ãŒã‚ã‚‹å ´åˆã®ã¿ã‚³ãƒŸãƒƒãƒˆ
          if ! git diff --staged --quiet; then
            # ä¸€æ™‚çš„ã«stashã—ã¦æœ€æ–°ã‚’å–å¾—
            git stash push -m "temp-changes" || true
            
            # æœ€æ–°ã‚’å–å¾—ï¼ˆã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆå›é¿ï¼‰
            git fetch origin main
            git reset --hard origin/main
            
            # stashã‚’æˆ»ã™ï¼ˆã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆãŒã‚ã‚Œã°ä¸Šæ›¸ãï¼‰
            git stash pop || git checkout stash -- . || true
            
            # å†åº¦ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ã—ã¦ã‚³ãƒŸãƒƒãƒˆ
            git add data/models/weights.json data/archive/ || true
            git commit -m "ğŸ§ª 2025å¹´ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº† - $(date +'%Y-%m-%d %H:%M')" || true
            git push origin main || true
          else
            echo "No changes to commit"
          fi

      # 5. å®Œäº†é€šçŸ¥
      - name: ğŸ“± é€šçŸ¥ã‚’é€ä¿¡
        if: github.event.inputs.notify != 'false'
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: python scripts/notifier.py --type optimize --status success || echo "Notification skipped"
