name: ğŸ”„ éå»äºˆæƒ³å†ç”Ÿæˆ

on:
  workflow_dispatch:
    inputs:
      dates:
        description: 'æ—¥ä»˜ï¼ˆYYYYMMDDå½¢å¼ã€ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§è¤‡æ•°æŒ‡å®šå¯ã€ç©ºæ¬„ã§å…¨æœŸé–“ï¼‰'
        required: false
        default: ''
        type: string
      force:
        description: 'æ—¢å­˜ã®äºˆæƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¸Šæ›¸ãã™ã‚‹'
        required: false
        default: false
        type: boolean

jobs:
  regenerate:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      - name: ğŸ“¥ ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ğŸ Python ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: ğŸ“¦ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          pip install requests beautifulsoup4
      
      - name: ğŸ”„ éå»äºˆæƒ³ã‚’å†ç”Ÿæˆ
        run: |
          echo "=============================================="
          echo "ğŸ”„ éå»äºˆæƒ³å†ç”Ÿæˆ"
          echo "=============================================="
          
          if [ -n "${{ github.event.inputs.dates }}" ]; then
            # ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã®æ—¥ä»˜ã‚’å¼•æ•°ã«å¤‰æ›
            DATES=$(echo "${{ github.event.inputs.dates }}" | tr ',' ' ')
            echo "æŒ‡å®šæ—¥ä»˜: $DATES"
            
            if [ "${{ github.event.inputs.force }}" = "true" ]; then
              python scripts/regenerate_predictions.py $DATES --force
            else
              python scripts/regenerate_predictions.py $DATES
            fi
          else
            # å…¨æœŸé–“
            echo "å…¨æœŸé–“ã‚’å‡¦ç†"
            
            if [ "${{ github.event.inputs.force }}" = "true" ]; then
              python scripts/regenerate_predictions.py --force
            else
              python scripts/regenerate_predictions.py
            fi
          fi
      
      - name: ğŸ“Š ç”Ÿæˆçµæœã‚’ç¢ºèª
        run: |
          echo "=============================================="
          echo "ğŸ“Š ç”Ÿæˆã•ã‚ŒãŸäºˆæƒ³ãƒ•ã‚¡ã‚¤ãƒ«"
          echo "=============================================="
          ls -la data/predictions_*.json | head -20
          echo ""
          echo "åˆè¨ˆ: $(ls -1 data/predictions_*.json 2>/dev/null | wc -l) ãƒ•ã‚¡ã‚¤ãƒ«"
      
      - name: ğŸ“¤ å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆãƒ»ãƒ—ãƒƒã‚·ãƒ¥
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # å¤‰æ›´ãŒã‚ã‚‹ã‹ç¢ºèª
          if [ -n "$(git status --porcelain data/predictions_*.json 2>/dev/null)" ]; then
            git add data/predictions_*.json
            git commit -m "ğŸ”„ éå»äºˆæƒ³ã‚’å†ç”Ÿæˆ ($(date '+%Y-%m-%d %H:%M'))"
            
            # stashæ–¹å¼ã§ãƒ—ãƒƒã‚·ãƒ¥
            git stash push -m "temp-changes" --include-untracked || true
            git fetch origin main
            git reset --hard origin/main
            git stash pop || true
            git add data/predictions_*.json
            git commit -m "ğŸ”„ éå»äºˆæƒ³ã‚’å†ç”Ÿæˆ ($(date '+%Y-%m-%d %H:%M'))" || true
            git push origin main
            
            echo "âœ… äºˆæƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ—ãƒƒã‚·ãƒ¥ã—ã¾ã—ãŸ"
          else
            echo "â„¹ï¸ å¤‰æ›´ãªã—ï¼ˆæ–°ã—ã„äºˆæƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã‚ã‚Šã¾ã›ã‚“ï¼‰"
          fi
      
      - name: ğŸ“± Discordé€šçŸ¥
        if: always()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          if [ -n "$DISCORD_WEBHOOK" ]; then
            PRED_COUNT=$(ls -1 data/predictions_*.json 2>/dev/null | wc -l)
            
            curl -H "Content-Type: application/json" \
                 -X POST \
                 -d "{\"content\": \"ğŸ”„ **éå»äºˆæƒ³å†ç”Ÿæˆå®Œäº†**\näºˆæƒ³ãƒ•ã‚¡ã‚¤ãƒ«æ•°: ${PRED_COUNT}ä»¶\"}" \
                 "$DISCORD_WEBHOOK" || true
          fi
