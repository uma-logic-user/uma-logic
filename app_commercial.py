import streamlit as st
import pandas as pd
import numpy as np
import requests
from bs4 import BeautifulSoup
import datetime
import time

# ---------------------------------------------------------
# 1. è¨­å®šã¨ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
# ---------------------------------------------------------
st.set_page_config(page_title="ç«¶é¦¬äºˆæƒ³AI - é–‹å‚¬ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç›£è¦–ä»˜ã", layout="wide")

# ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°é–¢æ•°ã®å®šç¾©ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥åŒ–ã—ã¦è² è·è»½æ¸›ï¼‰
# ttl=600 ã¯ã€Œ600ç§’(10åˆ†)é–“ã¯çµæœã‚’ä¿å­˜ã—ã€å†ã‚¢ã‚¯ã‚»ã‚¹ã—ãªã„ã€ã¨ã„ã†æ„å‘³ã§ã™
@st.cache_data(ttl=600)
def check_netkeiba_status(target_date_str, venue_name):
    """
    netkeibaã®é–‹å‚¬æƒ…å ±ã‚’ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ã—ã€æŒ‡å®šä¼šå ´ã®çŠ¶æ…‹ã‚’ç¢ºèªã™ã‚‹ã€‚
    æˆ»ã‚Šå€¤: (status_text, is_cancelled)
    Example: ('é–‹å‚¬ä¸­', False) ã¾ãŸã¯ ('ä¸­æ­¢', True)
    """
    # æ—¥ä»˜ã‚’YYYYMMDDå½¢å¼ã«å¤‰æ› (ä¾‹: 20231028)
    try:
        dt = datetime.datetime.strptime(target_date_str, '%Y-%m-%d')
        formatted_date = dt.strftime('%Y%m%d')
    except ValueError:
        return "æ—¥ä»˜ã‚¨ãƒ©ãƒ¼", False

    # netkeibaã®ãƒ¬ãƒ¼ã‚¹ä¸€è¦§ãƒšãƒ¼ã‚¸ï¼ˆæ—¥ä»˜æŒ‡å®šï¼‰
    url = f"https://race.netkeiba.com/top/race_list.html?kaisai_date={formatted_date}"
    
    try:
        # å®Ÿéš›ã®ã‚¢ã‚¯ã‚»ã‚¹ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ä»˜ã‘ã¦ãƒ–ãƒ©ã‚¦ã‚¶ã®ãµã‚Šã‚’ã™ã‚‹ï¼‰
        headers = {'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36'}
        response = requests.get(url, headers=headers, timeout=5)
        response.encoding = 'EUC-JP' # netkeibaã¯EUC-JPãŒå¤šã„ãŒã€é©å®œèª¿æ•´
        
        soup = BeautifulSoup(response.text, 'html.parser')
        
        # ãƒšãƒ¼ã‚¸å†…ã«ã€Œä¸­æ­¢ã€ã‚„ã€Œå»¶æœŸã€ã®æ–‡è¨€ãŒã‚ã‚Šã€ã‹ã¤å¯¾è±¡ä¼šå ´åãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ç°¡æ˜“ãƒã‚§ãƒƒã‚¯
        # â€»æœ¬æ¥ã¯HTMLæ§‹é€ ã‚’å³å¯†ã«è§£æã—ã¾ã™ãŒã€ã‚µã‚¤ãƒˆæ§‹é€ å¤‰æ›´ã«å¼·ãã™ã‚‹ãŸã‚
        #   ãƒšãƒ¼ã‚¸å…¨ä½“ã‹ã‚‰ã€Œä¼šå ´åã€ã¨ã€Œä¸­æ­¢ã€ãŒè¿‘ãã«ã‚ã‚‹ã‹ã‚’æ¢ã™ãƒ­ã‚¸ãƒƒã‚¯ã«ã—ã¦ã„ã¾ã™ã€‚
        
        # é–‹å‚¬å ´ãƒªã‚¹ãƒˆã‚’å–å¾— (netkeibaã®æ§‹é€ ã«ä¾å­˜ã—ã¾ã™ã€‚ã‚¯ãƒ©ã‚¹åã¯å¤‰ã‚ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™)
        race_data_list = soup.find('div', class_='RaceList_DataList')
        
        if not race_data_list:
            # ãƒ‡ãƒ¼ã‚¿ãŒå–ã‚Œãªã„å ´åˆã¯ã€å®‰å…¨å´ã«å€’ã—ã¦ã€Œä¸æ˜ï¼ˆé€šå¸¸ï¼‰ã€ã¨ã™ã‚‹ã‹è­¦å‘Šã‚’å‡ºã™
            return "æƒ…å ±å–å¾—ä¸å¯(é€šå¸¸æƒ³å®š)", False

        # å…¨ãƒ†ã‚­ã‚¹ãƒˆã‚’å–å¾—
        page_text = race_data_list.get_text()

        # ã‚·ãƒ³ãƒ—ãƒ«ãªã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œçŸ¥ãƒ­ã‚¸ãƒƒã‚¯
        # å®Ÿéš›ã®DOMæ§‹é€ : <div class="RaceList_DataList"> ... <span class="JyoName">æ±äº¬</span> ... <span class="Cancel">ä¸­æ­¢</span> ... </div>
        # ã“ã“ã§ã¯ç°¡æ˜“çš„ã«ã€ä¼šå ´åãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã€ã•ã‚‰ã«ãã®ãƒ–ãƒ­ãƒƒã‚¯ã«ä¸­æ­¢ãƒ•ãƒ©ã‚°ãŒã‚ã‚‹ã‹ç¢ºèªã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
        
        # ãƒ‡ãƒ¢ç”¨ãƒ­ã‚¸ãƒƒã‚¯: 
        # æœ¬æ¥ã¯ã“ã“ã§BeautifulSoupã§ä¼šå ´ã”ã¨ã®ãƒ–ãƒ­ãƒƒã‚¯ã‚’ç‰¹å®šã—ã¾ã™ã€‚
        # ä»Šå›ã¯ã€Œè©²å½“ä¼šå ´ã®ãƒ–ãƒ­ãƒƒã‚¯ã€ã‚’æ¢ã™å‡¦ç†ã‚’ã‚¤ãƒ¡ãƒ¼ã‚¸ã§å®Ÿè£…ã—ã¾ã™ã€‚
        
        venue_found = False
        is_cancelled = False
        status_msg = "é–‹å‚¬äºˆå®š"

        # netkeibaã®æ§‹é€ : class="RaceList_Data" ãŒå„ä¼šå ´ã®ãƒ–ãƒ­ãƒƒã‚¯
        venues_blocks = soup.find_all('div', class_='RaceList_Data')
        
        for block in venues_blocks:
            block_text = block.get_text()
            if venue_name in block_text:
                venue_found = True
                # ã“ã®ãƒ–ãƒ­ãƒƒã‚¯å†…ã«ã€Œä¸­æ­¢ã€ã€Œå»¶æœŸã€ã®æ–‡å­—ãŒã‚ã‚‹ã‹
                if "ä¸­æ­¢" in block_text or "å»¶æœŸ" in block_text:
                    is_cancelled = True
                    status_msg = "é–‹å‚¬ä¸­æ­¢ãƒ»å»¶æœŸ"
                elif "é›ª" in block_text and "å½±éŸ¿" in block_text:
                    status_msg = "å¤©å€™èª¿æŸ»ä¸­" # æ³¨æ„å–šèµ·ã®ã¿
                break
        
        if not venue_found:
            return "é–‹å‚¬ãªã—", False
            
        return status_msg, is_cancelled

    except Exception as e:
        # ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒ­ã‚°ã‚’å‡ºã—ã¦ã€ã‚¢ãƒ—ãƒªã‚’æ­¢ã‚ãªã„ï¼ˆé€šå¸¸æ‰±ã„ã«ã™ã‚‹ã‹ã€ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºã™ã‚‹ã‹ï¼‰
        print(f"Scraping Error: {e}")
        return "æ¥ç¶šã‚¨ãƒ©ãƒ¼(æ‰‹å‹•ç¢ºèªæ¨å¥¨)", False

# ---------------------------------------------------------
# 2. ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³
# ---------------------------------------------------------

def main():
    st.title("ğŸ‡ AIç«¶é¦¬äºˆæƒ³ã‚·ã‚¹ãƒ†ãƒ  Commercial Ver.")
    st.markdown("---")

    # --- ã‚µã‚¤ãƒ‰ãƒãƒ¼è¨­å®š ---
    st.sidebar.header("é–‹å‚¬è¨­å®š")
    
    # æ—¥ä»˜é¸æŠ
    today = datetime.date.today()
    target_date = st.sidebar.date_input("é–‹å‚¬æ—¥é¸æŠ", today)
    target_date_str = target_date.strftime('%Y-%m-%d')

    # ä¼šå ´é¸æŠ
    venue = st.sidebar.selectbox("é–‹å‚¬ä¼šå ´", ["æ±äº¬", "ä¸­å±±", "äº¬éƒ½", "é˜ªç¥", "æ–°æ½Ÿ", "ç¦å³¶", "ä¸­äº¬", "æœ­å¹Œ", "å‡½é¤¨", "å°å€‰"])

    # ã€ãƒ‡ãƒãƒƒã‚°æ©Ÿèƒ½ã€‘é–‹ç™ºä¸­ã«å‹•ä½œã‚’ç¢ºèªã™ã‚‹ãŸã‚ã®å¼·åˆ¶ã‚¹ã‚¤ãƒƒãƒ
    st.sidebar.markdown("---")
    st.sidebar.subheader("ğŸ›  ãƒ‡ãƒãƒƒã‚°ãƒ»ãƒ†ã‚¹ãƒˆç”¨")
    simulate_cancel = st.sidebar.checkbox("ã€ãƒ†ã‚¹ãƒˆã€‘å¼·åˆ¶çš„ã«ã€ä¸­æ­¢ã€çŠ¶æ…‹ã«ã™ã‚‹")

    # ---------------------------------------------------------
    # 3. é–‹å‚¬ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒã‚§ãƒƒã‚¯å‡¦ç† (ã“ã“ãŒä»Šå›ã®è‚)
    # ---------------------------------------------------------
    
    # ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ã‹ã€å®Ÿéš›ã®ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°çµæœã‹
    if simulate_cancel:
        status_text = "ãƒ†ã‚¹ãƒˆç”¨ï¼šé–‹å‚¬ä¸­æ­¢"
        is_cancelled = True
    else:
        with st.spinner(f'{venue}ç«¶é¦¬å ´ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ç¢ºèªä¸­...'):
            status_text, is_cancelled = check_netkeiba_status(target_date_str, venue)

    # ---------------------------------------------------------
    # 4. ç”»é¢è¡¨ç¤ºåˆ¶å¾¡ (ãƒ­ãƒƒã‚¯æ©Ÿèƒ½)
    # ---------------------------------------------------------
    
    # çŠ¶æ…‹å¤‰æ•°ã®åˆæœŸåŒ–
    ui_disabled = False # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯æ“ä½œå¯èƒ½

    if is_cancelled:
        # ä¸­æ­¢ã®å ´åˆã®è­¦å‘Šè¡¨ç¤º
        st.error(f"""
        ### âš ï¸ é‡å¤§ãªãŠçŸ¥ã‚‰ã›: {venue}ç«¶é¦¬å ´ã¯ã€Œ{status_text}ã€ã¨ãªã£ã¦ã„ã¾ã™ã€‚
        
        æœ¬æ—¥ã®{venue}é–‹å‚¬ã¯ä¸­æ­¢ã¾ãŸã¯å»¶æœŸãŒæ¤œçŸ¥ã•ã‚Œã¾ã—ãŸã€‚
        è³‡é‡‘ä¿è­·ã®ãŸã‚ã€**æŠ•è³‡è¨ˆç®—ãŠã‚ˆã³æŠ•ç¥¨æ©Ÿèƒ½ã¯ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã™ã€‚**
        
        â€»ä»£æ›¿é–‹å‚¬ï¼ˆç¶šè¡Œç«¶é¦¬ï¼‰ãŒã‚ã‚‹å ´åˆã¯ã€å¾Œæ—¥ç™ºè¡¨ã•ã‚Œã‚‹æ–°ã—ã„æ—¥ç¨‹ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚
        """)
        
        # UIã‚’ãƒ­ãƒƒã‚¯ã™ã‚‹ãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã‚‹
        ui_disabled = True
    
    elif status_text == "é–‹å‚¬ãªã—":
        st.warning(f"{target_date_str} ã® {venue} ã§ã®é–‹å‚¬ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚æ—¥ç¨‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚")
        ui_disabled = True

    else:
        # é€šå¸¸é–‹å‚¬æ™‚
        st.success(f"ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèªOK: {venue} ({status_text}) - æ­£å¸¸ç¨¼åƒä¸­")

    # ---------------------------------------------------------
    # 5. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³æœ¬ä½“ (ãƒ­ãƒƒã‚¯ãƒ•ãƒ©ã‚°ã‚’é©ç”¨)
    # ---------------------------------------------------------

    col1, col2 = st.columns([2, 1])

    with col1:
        st.subheader("ğŸ“Š ãƒ¬ãƒ¼ã‚¹åˆ†æãƒ‡ãƒ¼ã‚¿")
        # ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ã®ä½œæˆ
        df = pd.DataFrame({
            'ãƒ¬ãƒ¼ã‚¹': [f'{i}R' for i in range(1, 13)],
            'æœ¬å‘½é¦¬': np.random.choice(['ãƒ‡ã‚£ãƒ¼ãƒ—ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆ', 'ã‚ªãƒ«ãƒ•ã‚§ãƒ¼ãƒ´ãƒ«', 'ã‚¤ã‚¯ã‚¤ãƒãƒƒã‚¯ã‚¹'], 12),
            'AIè‡ªä¿¡åº¦': np.random.randint(60, 100, 12),
            'ã‚ªãƒƒã‚º': np.round(np.random.uniform(1.5, 10.0, 12), 1)
        })
        
        # ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ è¡¨ç¤ºï¼ˆã“ã“ã¯è¦‹ã‚‹ã ã‘ãªã®ã§ãƒ­ãƒƒã‚¯ã—ãªãã¦ã‚‚è‰¯ã„ãŒã€è­¦å‘Šã¯è¦‹ãˆã¦ã„ã‚‹ï¼‰
        st.dataframe(df, use_container_width=True)

    with col2:
        st.subheader("ğŸ’° æŠ•è³‡è¨ˆç®—æ©Ÿ")
        
        # ãƒ­ãƒƒã‚¯æ©Ÿèƒ½ã®é©ç”¨ç®‡æ‰€: disabled=ui_disabled ã‚’è¨­å®š
        
        budget = st.number_input(
            "ç·äºˆç®— (å††)", 
            min_value=1000, 
            value=10000, 
            step=1000, 
            disabled=ui_disabled  # <--- ã“ã“ã§ãƒ­ãƒƒã‚¯
        )
        
        target_race = st.selectbox(
            "å¯¾è±¡ãƒ¬ãƒ¼ã‚¹", 
            df['ãƒ¬ãƒ¼ã‚¹'], 
            disabled=ui_disabled  # <--- ã“ã“ã§ãƒ­ãƒƒã‚¯
        )
        
        allocation_method = st.radio(
            "è³‡é‡‘é…åˆ†ãƒ­ã‚¸ãƒƒã‚¯",
            ["å‡ç­‰è²·ã„", "ã‚ªãƒƒã‚ºæ¯”ä¾‹é…åˆ†", "ã‚±ãƒªãƒ¼åŸºæº–"],
            disabled=ui_disabled  # <--- ã“ã“ã§ãƒ­ãƒƒã‚¯
        )

        # è¨ˆç®—å®Ÿè¡Œãƒœã‚¿ãƒ³
        if st.button("æŠ•è³‡é…åˆ†ã‚’è¨ˆç®—ã™ã‚‹", type="primary", disabled=ui_disabled): # <--- ã“ã“ã§ãƒ­ãƒƒã‚¯
            
            # ä»¥ä¸‹ã€è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆãƒ­ãƒƒã‚¯æ™‚ã¯å®Ÿè¡Œã•ã‚Œãªã„ï¼‰
            st.markdown("### æ¨å¥¨è²·ã„ç›®")
            st.info(f"{target_race} ã« {allocation_method} ã§è¨ˆç®—ã‚’å®Ÿè¡Œã—ã¾ã—ãŸã€‚")
            
            alloc_amount = budget // 5 # ãƒ€ãƒŸãƒ¼è¨ˆç®—
            st.write(f"æ¨å¥¨æŠ•è³‡é¡: **{alloc_amount:,}å††** / ç‚¹")
            
            # ã‚°ãƒ©ãƒ•æç”»ãªã©
            chart_data = pd.DataFrame({
                "é¦¬ç•ª": [1, 2, 3, 4, 5],
                "é…åˆ†é¡": np.random.randint(1000, 3000, 5)
            })
            st.bar_chart(chart_data.set_index("é¦¬ç•ª"))

    # ä»£æ›¿é–‹å‚¬ã«é–¢ã™ã‚‹æ¡ˆå†…ï¼ˆãƒ­ãƒƒã‚¯æ™‚ã®ã¿è¡¨ç¤ºï¼‰
    if ui_disabled and is_cancelled:
        st.markdown("---")
        st.info("""
        **ã€ä»£æ›¿é–‹å‚¬ã«ã¤ã„ã¦ã€‘**
        JRAç­‰ã®å…¬å¼ç™ºè¡¨ã«ã‚ˆã‚Šä»£æ›¿é–‹å‚¬æ—¥ãŒæ±ºå®šã—ãŸå ´åˆã€
        ã‚µã‚¤ãƒ‰ãƒãƒ¼ã®ã€Œé–‹å‚¬æ—¥é¸æŠã€ã‹ã‚‰æ–°ã—ã„æ—¥ä»˜ã‚’é¸æŠã™ã‚‹ã“ã¨ã§ã€å†åº¦åˆ†æãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚
        """)

if __name__ == "__main__":
    main()
