# UMA-Logic PRO - バックテスト修正版

## 📋 修正概要

### 問題点
- **的中率100%** という異常値が発生していた
- 原因: **データリーク**（結果データを特徴量に含めていた可能性）

### 修正内容

#### 1. データリーク防止
特徴量から以下の「結果データ」を完全排除:
- 着順
- タイム
- 上がり3F
- 払戻金

**使用する特徴量（レース前に分かる情報のみ）:**
- オッズ（発走前）
- 人気順
- 馬体重・増減
- 枠番
- 騎手
- 血統（父馬）
- 過去成績（前走以前のデータ）

#### 2. Train/Test分離の厳格化
```
学習データ（Train）: 2024年のレース
テストデータ（Test）: 2025年のレース
```

時系列を尊重し、**未来のデータで学習しない**ことを保証。

#### 3. 評価基準の明確化
- **的中判定**: ◎（最高スコアの馬）が1着になったか
- **回収率**: (的中時の払戻金合計) / (総投資額)

---

## 📁 修正ファイル

### `scripts/ensemble_agents.py`
厳格なバックテスト機能を持つアンサンブル学習エンジン

**主な機能:**
- `--optimize`: Train/Test分離で重み最適化
- `--backtest`: 現在の重みでバックテスト実行
- `--show-weights`: 現在の重みを表示

**使用例:**
```bash
# 重み最適化（Train: 2024年、Test: 2025年）
python scripts/ensemble_agents.py --optimize

# カスタム設定
python scripts/ensemble_agents.py --optimize --train-years 2024 --test-years 2025 --iterations 200

# バックテストのみ
python scripts/ensemble_agents.py --backtest

# 現在の重みを確認
python scripts/ensemble_agents.py --show-weights
```

### `app_commercial.py`
weights.json 自動適用機能を追加

**新機能:**
- サイドバーにAI重みをリアルタイム表示
- 「🧠 AI学習状況」タブを追加
- Train/Test分離の成績を表示
- 過学習チェック機能
- 重み再読み込みボタン

---

## 📊 期待される結果

### 修正前（異常値）
```
的中率: 100%
回収率: 939.4%
```

### 修正後（現実的な値）
```
的中率: 15-25%（単勝の平均的中率）
回収率: 70-90%（現実的な範囲）
```

**注意**: 単勝の平均的中率は約20%程度が現実的です。100%を超える的中率はデータリークの明確なサインです。

---

## 🔧 実行方法

### 1. 重み最適化の実行
```bash
cd /home/ubuntu/uma-logic
python scripts/ensemble_agents.py --optimize
```

### 2. Streamlit UIの起動
```bash
streamlit run app_commercial.py --server.port 8501
```

### 3. 結果の確認
- サイドバー: 現在のAI重みと成績
- 「🧠 AI学習状況」タブ: Train/Test分離の詳細

---

## ⚠️ 過学習のチェック方法

| 比率 (Train/Test) | 判定 |
|-------------------|------|
| 1.0 - 1.5 | ✅ 良好 |
| 1.5 - 2.0 | ⚡ 軽度の過学習 |
| 2.0以上 | ⚠️ 過学習の可能性 |

---

## 📝 今後の改善案

1. **特徴量エンジニアリング**
   - 騎手の勝率
   - 調教師の勝率
   - コース別成績

2. **モデルの多様化**
   - ランダムフォレスト
   - XGBoost
   - ニューラルネットワーク

3. **クロスバリデーション**
   - 時系列を考慮したK-Fold

---

## 📅 更新履歴

| 日付 | 内容 |
|------|------|
| 2025-02-03 | 初版作成（データリーク修正、Train/Test分離実装） |
