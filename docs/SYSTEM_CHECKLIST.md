# UMA-Logic システムチェックリスト

## 概要

このドキュメントは、UMA-Logic システムの動作確認用チェックリストです。
GitHub Actions で各ワークフローを実行する際の確認ポイントをまとめています。

---

## 1. データ取得系

### 📊 レース結果取得 (`fetch_results.yml`)

| チェック項目 | 期待される動作 |
|-------------|---------------|
| 日付判定 | GitHub Actions 環境では前日のデータを取得 |
| venue 取得 | race_id から競馬場名を正しく復元 |
| 払戻金取得 | 単勝、複勝、馬連、馬単、ワイド、三連複、三連単 |
| エラーハンドリング | 1レースのエラーで全体が止まらない |

**テスト方法**:
```
GitHub Actions → 📊 レース結果取得 → Run workflow
日付入力: 20260201（日曜日）
```

**期待される出力**:
```
[INFO] レースID探索開始: 2026年02月01日
[INFO] XX件のレースを発見しました
[INFO] 結果を保存しました: data/results_20260201.json
```

---

### 🐎 予想データ取得 (`fetch_predictions.yml`)

| チェック項目 | 期待される動作 |
|-------------|---------------|
| 全競馬場取得 | 当日開催の全競馬場を自動検出 |
| UMA指数計算 | 各馬のスコアを正しく計算 |
| 印付与 | ◎○▲△× を正しく付与 |

---

## 2. 予想再生成系

### 🔄 過去予想再生成 (`regenerate_predictions.yml`)

| チェック項目 | 期待される動作 |
|-------------|---------------|
| all_results 読み込み | results の all_results から馬データを取得 |
| オッズ→人気推定 | オッズから人気順を推定 |
| UMA指数計算 | 各馬のスコアを正しく計算 |

**テスト方法**:
```
GitHub Actions → 🔄 過去予想再生成 → Run workflow
dates: 空欄（全期間）
force: true
```

---

## 3. 検証系

### 📈 予想検証 (`verify_predictions.py`)

| チェック項目 | 期待される動作 |
|-------------|---------------|
| レース照合 | venue + race_num で照合 |
| 的中判定 | 単勝、複勝、馬連、馬単、ワイド、三連複、三連単 |
| 払戻計算 | 各券種の払戻金を正しく取得 |

**テスト方法**:
```bash
python scripts/verify_predictions.py 20260201
```

---

### 📊 全期間バックテスト (`run_backtest_all.py`)

| チェック項目 | 期待される動作 |
|-------------|---------------|
| 全日付処理 | predictions と results のペアを全て処理 |
| 券種別集計 | 各券種の的中率・回収率を集計 |
| リスク指標 | 最大ドローダウン、最大連敗を計算 |

---

## 4. UI系

### Streamlit UI (`app_commercial.py`)

| チェック項目 | 期待される動作 |
|-------------|---------------|
| レース結果表示 | venue が空でも race_id から復元して表示 |
| 予想表示 | ◎○▲△× と UMA指数を表示 |
| AI学習状況 | weights.json の内容を表示 |

---

## 5. 通知系

### Discord 通知 (`notifier.py`)

| チェック項目 | 期待される動作 |
|-------------|---------------|
| 重み通知 | Speed, Adaptability, Pedigree の重みを表示 |
| 成績通知 | Train/Test の的中率・回収率を表示 |
| エラーハンドリング | Webhook 未設定でもエラーにならない |

---

## データ構造

### predictions_YYYYMMDD.json

```json
{
  "date": "20260201",
  "generated_at": "2026-02-01 07:00:00",
  "races": [
    {
      "race_id": "202605010201",
      "venue": "東京",
      "race_num": 1,
      "race_name": "3歳未勝利",
      "honmei": {
        "umaban": 8,
        "horse_name": "サンデーモーニング",
        "uma_index": 76
      },
      "horses": [
        {
          "umaban": 8,
          "horse_name": "サンデーモーニング",
          "uma_index": 76,
          "mark": "◎"
        }
      ]
    }
  ]
}
```

### results_YYYYMMDD.json

```json
{
  "date": "2026-02-01",
  "updated_at": "2026-02-01 18:00:00",
  "races": [
    {
      "race_id": "202605010201",
      "venue": "東京",
      "race_num": 1,
      "race_name": "3歳未勝利",
      "top3": [
        {"着順": 1, "馬番": 8, "馬名": "サンデーモーニング", "オッズ": 3.5}
      ],
      "all_results": [...],
      "payouts": {
        "単勝": 350,
        "複勝": {"8": 150, "3": 200, "12": 180},
        "馬連": 1200,
        "馬単": 2500,
        "ワイド": {"8-3": 400, "8-12": 350, "3-12": 600},
        "三連複": 3500,
        "三連単": 15000
      }
    }
  ]
}
```

---

## トラブルシューティング

### レース結果が表示されない

1. `venue` が空になっていないか確認
2. `fix_venue_data.py` を実行して修正

```bash
python scripts/fix_venue_data.py
```

### 予想と結果が照合できない

1. `race_id` の形式が異なる場合、`venue + race_num` で照合される
2. `venue` が正しく設定されているか確認

### Discord 通知が来ない

1. `DISCORD_WEBHOOK` が設定されているか確認
2. GitHub Secrets に正しく登録されているか確認

---

## 更新履歴

| 日付 | 内容 |
|------|------|
| 2026-02-04 | 初版作成 |
| 2026-02-04 | venue 復元ロジック追加 |
| 2026-02-04 | regenerate_predictions.py の all_results 対応 |
