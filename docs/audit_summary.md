# UMA-Logic PRO - システム監査サマリー

**作成日**: 2026-02-03  
**目的**: 外部AIによるシステム精査のための情報提供

---

## 1. 現在の実績

| 指標 | Train (2024年) | Test (2025年) |
|------|---------------|---------------|
| 対象レース数 | 7,586 | 7,788 |
| **的中率** | 46.7% | **44.8%** |
| **回収率** | 126.1% | **121.7%** |

### ⚠️ 異常値の可能性

単勝の平均的中率は約 **20%** 程度が現実的です。  
現在の44.8%は平均の2倍以上であり、以下の可能性を検証する必要があります：

1. **データリーク**: 未来のデータ（着順・タイム・払戻金）を特徴量に含めていないか
2. **人気馬への偏り**: 1番人気の勝率は約30%程度。予測が人気順に近い場合、的中率が高くなる
3. **評価ロジックの誤り**: 的中判定が正しく実装されているか

---

## 2. 的中の定義

| 項目 | 定義 |
|------|------|
| **的中** | 「◎（最高スコアの馬）」が **1着** になった場合 |
| **的中率** | 的中したレース数 ÷ 全レース数 × 100 |
| **投資額** | 1レースあたり **100円**（単勝1点のみ） |
| **回収率** | 総払戻金 ÷ 総投資額 × 100 |

### 的中判定コード（ensemble_agents.py）

```python
# ◎（最高スコアの馬）を予測
top_pick_umaban = prediction[0][0]

# 的中判定：◎が1着になったか
hit = (top_pick_umaban == result.winner_umaban)
```

---

## 3. エージェント構成

3層のアンサンブル学習構造を採用しています。

| エージェント | 役割 | 現在の重み |
|-------------|------|-----------|
| **SpeedAgent** | スピード指数（タイム、上がり3F） | 34.77% |
| **AdaptabilityAgent** | 適性（コース、距離、馬場状態） | 35.67% |
| **PedigreeFormAgent** | 血統＋調子（種牡馬、騎手、前走成績） | 29.56% |

### 重み最適化

- **方法**: グリッドサーチ（10%刻み）
- **目的関数**: 回収率の最大化
- **制約**: 重みの合計 = 100%

---

## 4. データフロー

```
[netkeiba.com] → [fetch_predictions.py] → [predictions_YYYYMMDD.json]
                                              ↓
                                    [ensemble_agents.py]
                                              ↓
                                    [weights.json] ← 重み最適化
                                              ↓
[netkeiba.com] → [fetch_results.py] → [results_YYYYMMDD.json]
                                              ↓
                                    [history.json] ← 的中履歴
                                              ↓
                                    [app_commercial.py] → Streamlit UI
```

---

## 5. 現在の課題（要検証）

### 5.1 データリークの可能性

**検証ポイント**:
- `ensemble_agents.py` の `evaluate_prediction()` メソッドで、予測時に使用する特徴量に結果データ（着順、タイム、上がり3F、払戻金）が含まれていないか

**修正済み（2026-02-03）**:
- 着順、タイム、上がり3F、払戻金を特徴量から除外
- Train/Test分離を厳格化（2024年 vs 2025年）

### 5.2 的中判定の正確性

**検証ポイント**:
- `result.winner_umaban` が正しく1着馬の馬番を取得しているか
- `top3` リストの最初の要素が「1着馬」であることを確認

### 5.3 人気順との相関

**検証ポイント**:
- 予測結果が人気順（オッズ順）とどの程度相関しているか
- 相関が高い場合、AIの付加価値が低い可能性

---

## 6. ファイル構成

```
uma-logic/
├── app_commercial.py          # Streamlit UI（メイン）
├── scripts/
│   ├── ensemble_agents.py     # アンサンブル学習エンジン
│   ├── notifier.py            # Discord/LINE通知
│   ├── fetch_predictions.py   # 予想データ取得
│   └── fetch_results.py       # 結果データ取得
├── data/
│   ├── models/
│   │   └── weights.json       # AI重み設定
│   ├── archive/
│   │   └── index.json         # アーカイブインデックス
│   ├── predictions_*.json     # 予想データ
│   ├── results_*.json         # 結果データ
│   └── history.json           # 的中履歴
├── .github/workflows/
│   ├── optimize_2025.yml      # AI学習ワークフロー
│   ├── auto_update.yml        # 自動更新（土日）
│   ├── fetch_predictions.yml  # 予想取得
│   └── fetch_results.yml      # 結果取得
└── docs/
    ├── system_spec.md         # システム仕様書
    ├── audit_package.txt      # 全コード集約
    └── audit_summary.md       # 本ファイル
```

---

## 7. GitHub Actions スケジュール

| ワークフロー | トリガー | 説明 |
|-------------|---------|------|
| 🐎 予想データ取得 | 土日 07:00 JST + 手動 | レースデータ取得＋スコア計算 |
| 📊 レース結果取得 | 土日 18:00 JST + 手動 | 結果＋払戻金取得 |
| 🧠 AI学習 | 手動実行のみ | 重み最適化＋バックテスト |
| 💹 リアルタイムオッズ | 手動実行のみ | 直前オッズ取得＋インサイダー検知 |

**注**: `on: push` トリガーは削除済み。Manusの介入なしで自動運用可能。

---

## 8. 外部AIへの質問事項

1. **的中率44.8%は現実的か？**
   - 単勝の平均的中率20%と比較して異常に高い
   - データリークまたは評価ロジックの誤りの可能性

2. **回収率121.7%は持続可能か？**
   - 長期的に100%を超える回収率は稀
   - 過学習またはサンプルサイズの問題の可能性

3. **改善提案**
   - より厳密なバックテスト手法
   - 特徴量エンジニアリングの改善
   - 過学習防止のための正則化

---

## 9. 関連ファイル

- **全コード集約**: `docs/audit_package.txt`
- **システム仕様書**: `docs/system_spec.md`
- **AI重み設定**: `data/models/weights.json`

---

**作成者**: UMA-Logic PRO 開発チーム  
**連絡先**: GitHub Issues
