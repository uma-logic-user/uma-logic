# UMA-Logic PRO システム仕様書

## 概要

UMA-Logic PRO は、JRA競馬の予想を行うAIシステムです。3つのエージェント（Speed, Adaptability, PedigreeForm）のアンサンブル学習により、各馬のスコアを算出し、最も高いスコアの馬を「◎（本命）」として推奨します。

---

## 的中率の定義

### 現在の定義

| 項目 | 定義 |
|------|------|
| **的中** | 「◎（最高スコアの馬）」が **1着** になった場合 |
| **的中率** | 的中したレース数 ÷ 全レース数 × 100 |

### 判定ロジック（コード）

```python
# ◎（最高スコアの馬）を予測
top_pick_umaban = prediction[0][0]

# 的中判定：◎が1着になったか
hit = (top_pick_umaban == result.winner_umaban)
```

### 注意事項

- **3着以内ではなく、1着のみ** を的中としてカウント
- 複勝（3着以内）ではなく、単勝（1着）を基準としている
- 的中率が20%を大幅に超える場合は、データの整合性を確認する必要がある

---

## 回収率の定義

### 計算式

```
回収率 = 総払戻金 ÷ 総投資額 × 100
```

### 投資額の設定

| 項目 | 値 |
|------|-----|
| **1レースあたりの投資額** | 100円 |
| **購入点数** | 1点（単勝のみ） |
| **購入馬** | ◎（最高スコアの馬）のみ |

### 払戻金の計算

```python
# 的中時の払戻金
payout = winner_odds × 100円

# 例：オッズ5.0倍で的中した場合
payout = 5.0 × 100 = 500円
```

### 回収率の解釈

| 回収率 | 解釈 |
|--------|------|
| 100%以上 | プラス収支（利益が出ている） |
| 80-100% | ほぼ収支均衡 |
| 80%未満 | マイナス収支（損失が出ている） |

---

## バックテストの仕様

### Train/Test分離

| データセット | 対象年 | 用途 |
|-------------|--------|------|
| **Train** | 2024年 | 重み最適化に使用 |
| **Test** | 2025年 | 検証に使用（未知データ） |

### 過学習チェック

| Train/Test比率 | 判定 |
|----------------|------|
| 1.0 - 1.5 | ✅ 良好 |
| 1.5 - 2.0 | ⚡ 軽度の過学習 |
| 2.0以上 | ⚠️ 過学習の可能性 |

---

## エージェントの重み

### 最新の重み（2026-02-03更新）

| エージェント | 重み | 役割 |
|-------------|------|------|
| **SpeedAgent** | 34.77% | オッズ・人気・過去成績からスピードを推定 |
| **AdaptabilityAgent** | 35.67% | 枠順・馬場状態・馬体重から適応性を評価 |
| **PedigreeFormAgent** | 29.56% | 血統・騎手・調子を評価 |

### 重みの最適化方法

- **アルゴリズム**: ランダムサーチ + 勾配なし最適化
- **目的関数**: 回収率の最大化
- **イテレーション**: 100回（デフォルト）
- **学習率**: 0.1（デフォルト）

---

## データソース

### 使用データ

| 項目 | ソース |
|------|--------|
| レース情報 | netkeiba.com |
| オッズ | netkeiba.com（発走前オッズ） |
| 馬体重 | netkeiba.com |
| 着順・払戻金 | netkeiba.com（レース結果） |

### 特徴量（レース前に分かる情報のみ）

| 特徴量 | 説明 |
|--------|------|
| オッズ | 発走前の単勝オッズ |
| 人気順 | 発走前の人気順位 |
| 馬体重 | 当日の馬体重 |
| 馬体重増減 | 前走からの増減 |
| 枠番 | 枠番号（1-8） |
| 騎手 | 騎乗騎手名 |
| 父馬 | 血統（父） |

### 除外する特徴量（データリーク防止）

| 特徴量 | 理由 |
|--------|------|
| 着順 | レース結果 |
| タイム | レース結果 |
| 上がり3F | レース結果 |
| 払戻金 | レース結果 |

---

## 最新の学習結果

### 2026-02-03 更新

| 指標 | Train (2024年) | Test (2025年) |
|------|---------------|---------------|
| 対象レース数 | 7,586 | 7,788 |
| 的中数 | 3,543 | 3,488 |
| 的中率 | 46.7% | 44.8% |
| 総投資額 | 758,600円 | 778,800円 |
| 総払戻金 | 956,700円 | 947,412円 |
| 回収率 | 126.1% | 121.7% |

### 注意

的中率44.8%は単勝の平均的中率（約20%）より高い値です。以下の可能性を検討してください：

1. データの整合性問題（1着馬の判定が正しいか）
2. 人気馬に偏った予測をしている
3. 特定の条件下でのみ高い的中率を達成している

---

## 更新履歴

| 日付 | 内容 |
|------|------|
| 2026-02-03 | 初版作成（的中率・回収率の定義を明記） |
