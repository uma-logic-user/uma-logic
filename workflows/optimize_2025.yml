# .github/workflows/optimize_2025.yml
# UMA-Logic PRO - 2025å¹´ãƒ‡ãƒ¼ã‚¿ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼†AIå­¦ç¿’
# ã‚¹ãƒãƒ›ã‹ã‚‰ãƒœã‚¿ãƒ³ä¸€ã¤ã§å®Ÿè¡Œå¯èƒ½

name: ğŸ§ª 2025å¹´ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

on:
  workflow_dispatch:
    inputs:
      learning_rate:
        description: 'å­¦ç¿’ç‡ï¼ˆ0.01-0.5ï¼‰'
        required: false
        default: '0.1'
      iterations:
        description: 'æœ€é©åŒ–ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ•°'
        required: false
        default: '100'
      notify:
        description: 'é€šçŸ¥ã‚’é€ä¿¡ã™ã‚‹'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

env:
  TZ: Asia/Tokyo

jobs:
  simulate-2025:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      # ========================================
      # 1. ç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      # ========================================
      - name: ğŸ“¥ ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: ğŸ Pythonç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ğŸ“¦ ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: ğŸ“ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
        run: |
          mkdir -p data/archive
          mkdir -p data/models
          mkdir -p data/odds

      # ========================================
      # 2. ãƒ‡ãƒ¼ã‚¿æº–å‚™
      # ========================================
      - name: ğŸ“‚ å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–å½¢å¼ã«æ•´ç†
        id: archive
        run: |
          echo "=========================================="
          echo "ğŸ“‚ Step 1: ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–å½¢å¼ã«æ•´ç†"
          echo "=========================================="
          python scripts/archive_manager.py --archive-all
          
          # ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–çµ±è¨ˆã‚’å–å¾—
          ARCHIVE_COUNT=$(find data/archive -name "*.json" 2>/dev/null | wc -l)
          echo "archive_count=$ARCHIVE_COUNT" >> $GITHUB_OUTPUT
          echo "âœ… ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒ•ã‚¡ã‚¤ãƒ«æ•°: $ARCHIVE_COUNT"

      - name: ğŸ” ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’å†æ§‹ç¯‰
        id: index
        run: |
          echo "=========================================="
          echo "ğŸ” Step 2: ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’å†æ§‹ç¯‰"
          echo "=========================================="
          python scripts/archive_manager.py --rebuild-index
          
          # ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æƒ…å ±ã‚’å–å¾—
          if [ -f "data/archive/index.json" ]; then
            TOTAL_DATES=$(python3 -c "import json; d=json.load(open('data/archive/index.json')); print(d.get('total_dates', 0))")
            TOTAL_RACES=$(python3 -c "import json; d=json.load(open('data/archive/index.json')); print(d.get('total_races', 0))")
            echo "total_dates=$TOTAL_DATES" >> $GITHUB_OUTPUT
            echo "total_races=$TOTAL_RACES" >> $GITHUB_OUTPUT
            echo "âœ… ç·é–‹å‚¬æ—¥æ•°: $TOTAL_DATES"
            echo "âœ… ç·ãƒ¬ãƒ¼ã‚¹æ•°: $TOTAL_RACES"
          fi

      # ========================================
      # 3. 2025å¹´ãƒ‡ãƒ¼ã‚¿ã§AIå­¦ç¿’
      # ========================================
      - name: ğŸ§  2025å¹´ãƒ‡ãƒ¼ã‚¿ã§AIå­¦ç¿’ã‚’å®Ÿè¡Œ
        id: optimize
        run: |
          echo "=========================================="
          echo "ğŸ§  Step 3: 2025å¹´ãƒ‡ãƒ¼ã‚¿ã§AIå­¦ç¿’"
          echo "=========================================="
          echo "å­¦ç¿’ç‡: ${{ github.event.inputs.learning_rate }}"
          echo "ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³: ${{ github.event.inputs.iterations }}"
          echo ""
          
          # 2025å¹´ãƒ‡ãƒ¼ã‚¿ã§æœ€é©åŒ–ã‚’å®Ÿè¡Œ
          python scripts/ensemble_agents.py --optimize --source data/archive/2025 \
            --learning-rate ${{ github.event.inputs.learning_rate }} \
            --iterations ${{ github.event.inputs.iterations }}
          
          # çµæœã‚’å–å¾—
          if [ -f "data/models/weights.json" ]; then
            echo ""
            echo "=========================================="
            echo "ğŸ“Š å­¦ç¿’çµæœ"
            echo "=========================================="
            
            # weights.json ã‹ã‚‰çµæœã‚’æŠ½å‡º
            HIT_RATE=$(python3 -c "import json; d=json.load(open('data/models/weights.json')); print(d.get('optimization_metrics', {}).get('hit_rate', 0))")
            ROI=$(python3 -c "import json; d=json.load(open('data/models/weights.json')); print(d.get('optimization_metrics', {}).get('roi', 0))")
            SPEED_W=$(python3 -c "import json; d=json.load(open('data/models/weights.json')); print(d.get('weights', {}).get('speed_agent', 0))")
            ADAPT_W=$(python3 -c "import json; d=json.load(open('data/models/weights.json')); print(d.get('weights', {}).get('adaptability_agent', 0))")
            PEDIGREE_W=$(python3 -c "import json; d=json.load(open('data/models/weights.json')); print(d.get('weights', {}).get('pedigree_agent', 0))")
            
            echo "hit_rate=$HIT_RATE" >> $GITHUB_OUTPUT
            echo "roi=$ROI" >> $GITHUB_OUTPUT
            echo "speed_weight=$SPEED_W" >> $GITHUB_OUTPUT
            echo "adaptability_weight=$ADAPT_W" >> $GITHUB_OUTPUT
            echo "pedigree_weight=$PEDIGREE_W" >> $GITHUB_OUTPUT
            
            echo ""
            echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
            echo "â”‚       ğŸ¯ 2025å¹´ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çµæœ      â”‚"
            echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
            printf "â”‚  çš„ä¸­ç‡:     %6.2f%%                â”‚\n" $(echo "$HIT_RATE * 100" | bc -l)
            printf "â”‚  å›åç‡:     %6.2f%%                â”‚\n" $(echo "$ROI * 100" | bc -l)
            echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
            echo "â”‚       âš–ï¸ æœ€é©åŒ–ã•ã‚ŒãŸã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆé‡ã¿     â”‚"
            echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
            printf "â”‚  Speed:      %6.2f%%                â”‚\n" $(echo "$SPEED_W * 100" | bc -l)
            printf "â”‚  Adaptability: %6.2f%%              â”‚\n" $(echo "$ADAPT_W * 100" | bc -l)
            printf "â”‚  Pedigree:   %6.2f%%                â”‚\n" $(echo "$PEDIGREE_W * 100" | bc -l)
            echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
          else
            echo "[WARN] weights.json ãŒç”Ÿæˆã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ"
            echo "hit_rate=0" >> $GITHUB_OUTPUT
            echo "roi=0" >> $GITHUB_OUTPUT
          fi

      # ========================================
      # 4. çµæœã‚’è‡ªå‹•ä¿å­˜ï¼ˆé‡è¦ï¼‰
      # ========================================
      - name: ğŸ’¾ å­¦ç¿’çµæœã‚’ãƒªãƒã‚¸ãƒˆãƒªã«è‡ªå‹•ä¿å­˜
        run: |
          echo "=========================================="
          echo "ğŸ’¾ Step 4: å­¦ç¿’çµæœã‚’GitHubã«ä¿å­˜"
          echo "=========================================="
          
          git config --local user.email "action@github.com"
          git config --local user.name "UMA-Logic Bot"
          
          # ãƒªãƒ¢ãƒ¼ãƒˆã®æœ€æ–°ã‚’å–å¾—
          git pull --rebase origin main || git pull origin main
          
          # å¤‰æ›´ã‚’ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°
          git add data/models/weights.json
          git add data/archive/
          
          # å¤‰æ›´ãŒã‚ã‚Œã°ã‚³ãƒŸãƒƒãƒˆ
          if git diff --staged --quiet; then
            echo "ğŸ“­ å¤‰æ›´ãªã—ï¼ˆæ—¢ã«æœ€æ–°ï¼‰"
          else
            COMMIT_MSG="ğŸ§ª 2025å¹´ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†: çš„ä¸­ç‡ ${{ steps.optimize.outputs.hit_rate }}, å›åç‡ ${{ steps.optimize.outputs.roi }}"
            git commit -m "$COMMIT_MSG"
            git push
            echo "âœ… å­¦ç¿’çµæœã‚’GitHubã«ä¿å­˜ã—ã¾ã—ãŸ"
          fi

      # ========================================
      # 5. å®Œäº†é€šçŸ¥
      # ========================================
      - name: ğŸ“± Discord/LINE/Slackã«é€šçŸ¥ã‚’é€ä¿¡
        if: github.event.inputs.notify != 'false'
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          LINE_NOTIFY_TOKEN: ${{ secrets.LINE_NOTIFY_TOKEN }}
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
        run: |
          echo "=========================================="
          echo "ğŸ“± Step 5: å®Œäº†é€šçŸ¥ã‚’é€ä¿¡"
          echo "=========================================="
          
          # é€šçŸ¥ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œ
          python scripts/notifier.py --type optimize --status success
          
          # Discord WebhookãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã€è©³ç´°ãªçµæœã‚’é€ä¿¡
          if [ -n "$DISCORD_WEBHOOK" ]; then
            curl -H "Content-Type: application/json" \
              -d '{
                "embeds": [{
                  "title": "ğŸ§ª 2025å¹´ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†",
                  "description": "2025å¹´ã®éå»ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã—ãŸAIå­¦ç¿’ãŒå®Œäº†ã—ã¾ã—ãŸã€‚",
                  "color": 10233776,
                  "fields": [
                    {"name": "ğŸ“Š çš„ä¸­ç‡", "value": "${{ steps.optimize.outputs.hit_rate }}", "inline": true},
                    {"name": "ğŸ’° å›åç‡", "value": "${{ steps.optimize.outputs.roi }}", "inline": true},
                    {"name": "ğŸ“ å¯¾è±¡ãƒ¬ãƒ¼ã‚¹æ•°", "value": "${{ steps.index.outputs.total_races }}", "inline": true},
                    {"name": "âš–ï¸ Speedé‡ã¿", "value": "${{ steps.optimize.outputs.speed_weight }}", "inline": true},
                    {"name": "âš–ï¸ Adaptabilityé‡ã¿", "value": "${{ steps.optimize.outputs.adaptability_weight }}", "inline": true},
                    {"name": "âš–ï¸ Pedigreeé‡ã¿", "value": "${{ steps.optimize.outputs.pedigree_weight }}", "inline": true}
                  ],
                  "footer": {"text": "UMA-Logic PRO"},
                  "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"
                }]
              }' \
              "$DISCORD_WEBHOOK" || echo "[WARN] Discordé€šçŸ¥é€ä¿¡ã‚¨ãƒ©ãƒ¼"
          fi

      # ========================================
      # 6. ã‚µãƒãƒªãƒ¼å‡ºåŠ›
      # ========================================
      - name: ğŸ“‹ å®Ÿè¡Œã‚µãƒãƒªãƒ¼ã‚’å‡ºåŠ›
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘         ğŸ§ª 2025å¹´ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ å®Œäº†ã‚µãƒãƒªãƒ¼              â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘                                                           â•‘"
          echo "â•‘  ğŸ“‚ ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒ•ã‚¡ã‚¤ãƒ«æ•°: ${{ steps.archive.outputs.archive_count }}                          â•‘"
          echo "â•‘  ğŸ“… ç·é–‹å‚¬æ—¥æ•°: ${{ steps.index.outputs.total_dates }}                                  â•‘"
          echo "â•‘  ğŸ‡ ç·ãƒ¬ãƒ¼ã‚¹æ•°: ${{ steps.index.outputs.total_races }}                                  â•‘"
          echo "â•‘                                                           â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘                    ğŸ“Š å­¦ç¿’çµæœ                            â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘                                                           â•‘"
          echo "â•‘  ğŸ¯ çš„ä¸­ç‡: ${{ steps.optimize.outputs.hit_rate }}                                    â•‘"
          echo "â•‘  ğŸ’° å›åç‡: ${{ steps.optimize.outputs.roi }}                                    â•‘"
          echo "â•‘                                                           â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘                âš–ï¸ æœ€é©åŒ–ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆé‡ã¿                   â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘                                                           â•‘"
          echo "â•‘  Speed Agent:       ${{ steps.optimize.outputs.speed_weight }}                          â•‘"
          echo "â•‘  Adaptability Agent: ${{ steps.optimize.outputs.adaptability_weight }}                          â•‘"
          echo "â•‘  Pedigree Agent:    ${{ steps.optimize.outputs.pedigree_weight }}                          â•‘"
          echo "â•‘                                                           â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘  ğŸ’¾ weights.json ã¯è‡ªå‹•çš„ã«GitHubã«ä¿å­˜ã•ã‚Œã¾ã—ãŸ          â•‘"
          echo "â•‘  ğŸ“± æ¬¡å›ã®äºˆæƒ³ã‹ã‚‰æ–°ã—ã„é‡ã¿ãŒé©ç”¨ã•ã‚Œã¾ã™                  â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
