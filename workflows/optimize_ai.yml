# .github/workflows/optimize_ai.yml
# UMA-Logic PRO - AIå­¦ç¿’ãƒ»é‡ã¿æœ€é©åŒ–ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
# ã‚¹ãƒãƒ›ã‹ã‚‰ã€ŒAIå­¦ç¿’ãƒœã‚¿ãƒ³ã€ã‚’æŠ¼ã›ã‚‹

name: ğŸ§  AIå­¦ç¿’ï¼ˆé‡ã¿æœ€é©åŒ–ï¼‰

on:
  schedule:
    # æ¯é€±æœˆæ›œ03:00 JST (UTC 18:00 æ—¥æ›œ) - é€±æœ«ã®çµæœã‚’å­¦ç¿’
    - cron: '0 18 * * 0'
  workflow_dispatch:
    inputs:
      learning_period:
        description: 'å­¦ç¿’æœŸé–“ï¼ˆæœˆæ•°ï¼‰'
        required: false
        default: '6'
        type: choice
        options:
          - '3'
          - '6'
          - '12'
          - '24'
      notify:
        description: 'é€šçŸ¥ã‚’é€ä¿¡ã™ã‚‹'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

env:
  TZ: Asia/Tokyo

jobs:
  optimize-ai:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: ğŸ“¥ ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: ğŸ Pythonç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ğŸ“¦ ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: ğŸ“ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
        run: |
          mkdir -p data/archive
          mkdir -p data/models

      - name: ğŸ§  AIå­¦ç¿’ã‚’å®Ÿè¡Œ
        id: optimize
        run: |
          echo "=========================================="
          echo "ğŸ§  AIå­¦ç¿’ï¼ˆé‡ã¿æœ€é©åŒ–ï¼‰é–‹å§‹"
          echo "å­¦ç¿’æœŸé–“: ${{ github.event.inputs.learning_period || '6' }}ãƒ¶æœˆ"
          echo "=========================================="
          
          python scripts/ensemble_agents.py --optimize --months ${{ github.event.inputs.learning_period || '6' }}
          
          echo "optimize_status=success" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: ğŸ“Š å­¦ç¿’çµæœã‚’è¡¨ç¤º
        run: |
          echo "=========================================="
          echo "ğŸ“Š å­¦ç¿’çµæœ"
          echo "=========================================="
          if [ -f "data/models/weights.json" ]; then
            cat data/models/weights.json
          else
            echo "weights.json ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          fi

      - name: ğŸ’¾ å­¦ç¿’çµæœã‚’ã‚³ãƒŸãƒƒãƒˆï¼†ãƒ—ãƒƒã‚·ãƒ¥
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "UMA-Logic Bot"
          git pull --rebase origin main || git pull origin main
          git add data/models/
          if git diff --staged --quiet; then
            echo "ğŸ“­ å¤‰æ›´ãªã—"
          else
            git commit -m "ğŸ§  AIå­¦ç¿’å®Œäº†: $(date +'%Y-%m-%d %H:%M') - é‡ã¿æ›´æ–°"
            git push
            echo "âœ… å­¦ç¿’çµæœã‚’ãƒ—ãƒƒã‚·ãƒ¥ã—ã¾ã—ãŸ"
          fi

      - name: ğŸ“± é€šçŸ¥ã‚’é€ä¿¡
        if: github.event.inputs.notify != 'false'
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          LINE_NOTIFY_TOKEN: ${{ secrets.LINE_NOTIFY_TOKEN }}
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
        run: |
          python scripts/notifier.py --type optimize --status ${{ steps.optimize.outputs.optimize_status || 'completed' }}
        continue-on-error: true
