# .github/workflows/realtime_odds.yml
# UMA-Logic PRO - ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚ªãƒƒã‚ºå–å¾—ï¼†ã‚¤ãƒ³ã‚µã‚¤ãƒ€ãƒ¼æ¤œçŸ¥
# ã‚¹ãƒãƒ›ã‹ã‚‰æ‰‹å‹•å®Ÿè¡Œå¯èƒ½

name: ğŸ’¹ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚ªãƒƒã‚ºå–å¾—

on:
  workflow_dispatch:
    inputs:
      detect_insider:
        description: 'ã‚¤ãƒ³ã‚µã‚¤ãƒ€ãƒ¼æ¤œçŸ¥ã‚’å®Ÿè¡Œ'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
      notify:
        description: 'é€šçŸ¥ã‚’é€ä¿¡ã™ã‚‹'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

env:
  TZ: Asia/Tokyo

jobs:
  fetch-odds:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: ğŸ“¥ ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: ğŸ Pythonç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ğŸ“¦ ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: ğŸ“ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
        run: |
          mkdir -p data/odds
          mkdir -p data/archive

      - name: ğŸ’¹ ã‚ªãƒƒã‚ºã‚’å–å¾—
        id: odds
        run: |
          echo "=========================================="
          echo "ğŸ’¹ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚ªãƒƒã‚ºå–å¾—"
          echo "=========================================="
          python scripts/scraper_realtime.py --fetch
          echo "odds_status=success" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: ğŸš¨ ã‚¤ãƒ³ã‚µã‚¤ãƒ€ãƒ¼æ¤œçŸ¥
        if: github.event.inputs.detect_insider != 'false'
        id: insider
        run: |
          echo "=========================================="
          echo "ğŸš¨ ã‚¤ãƒ³ã‚µã‚¤ãƒ€ãƒ¼æ¤œçŸ¥"
          echo "=========================================="
          python scripts/scraper_realtime.py --detect
          
          # ã‚¢ãƒ©ãƒ¼ãƒˆãŒã‚ã‚‹ã‹ç¢ºèª
          if [ -f "data/insider_alerts.json" ]; then
            ALERT_COUNT=$(python -c "import json; data=json.load(open('data/insider_alerts.json')); print(len([a for a in data.get('alerts', []) if a.get('status')=='active']))")
            echo "insider_count=$ALERT_COUNT" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: ğŸ’¾ å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆï¼†ãƒ—ãƒƒã‚·ãƒ¥
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "UMA-Logic Bot"
          git pull --rebase origin main || git pull origin main
          git add data/
          if git diff --staged --quiet; then
            echo "ğŸ“­ å¤‰æ›´ãªã—"
          else
            git commit -m "ğŸ’¹ ã‚ªãƒƒã‚ºæ›´æ–°: $(date +'%Y-%m-%d %H:%M')"
            git push
            echo "âœ… ãƒ—ãƒƒã‚·ãƒ¥å®Œäº†"
          fi

      - name: ğŸ“± é€šçŸ¥ã‚’é€ä¿¡
        if: github.event.inputs.notify != 'false'
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          LINE_NOTIFY_TOKEN: ${{ secrets.LINE_NOTIFY_TOKEN }}
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
        run: |
          python scripts/notifier.py --type odds --insider-count ${{ steps.insider.outputs.insider_count || '0' }}
        continue-on-error: true
